
<!-- Show surveys when they are loaded -->
 

<!-- USER -->
<span *ngIf="!isUserAdmin && !isUserOfficer" class="user-layout">
  <body>
    <!-- <div class="brick-website"></div> -->
    <!-- <div class="nav-bar">
      asdasd
    </div> -->

    <header class="nav-bar">
      <!-- <div class="brick-text">BRICK SURVEY</div> -->
    </header>
    <div class="nav-bar-2">
      <a href="https://brick.bankrakyat.com.my/" class="brick-link">...</a>
    </div>
    
  <main>
    <div class="form-controller">
      <div class="box-image">
        
      </div>
      <!-- <h3>Survey Form</h3> -->
  
      <!-- Form submission handled by `createSurvey()` -->
      <form #myForm="ngForm" (ngSubmit)="create(myForm)" class="survey-form">

        <div class="user-information">
            
          <!-- User Name -->
          <div class="username-name"> 
            <!-- <p class="text-title-2">Name</p> -->
            <input
            type="text"
            placeholder="Enter your name"
            [(ngModel)]="newSurvey.name"
            name="username"
            required
            maxlength="30" 
            class="form-control focus-blue name"
            #name="ngModel"
            pattern="^[A-Z][a-zA-Z\s]*$"
            [ngClass]="{'error-border': name.invalid && name.touched, 'valid-border': name.valid && name.touched}"
          >
                     
            <!-- Validation Name -->
            <div *ngIf="(name.invalid && name.touched) || isCharacterLimitExceededName()">
              <small *ngIf="name.errors?.required" class="error-message-name">
                Please enter your name
              </small>
              <small *ngIf="isCharacterLimitExceededName()" class="error-message-name">
                Name cannot exceed 30 characters
              </small>
              <small *ngIf="name.errors?.pattern" class="error-message-name">
                Name must start with a capital letter and contain no numbers
              </small>
            </div>
            
          </div>
            
          <!-- PHONE NUMBER -->
            <div class="username-age">
              <!-- Phone No -->
              <input type="text"
                     id="phoneNumber"
                     placeholder="Phone Number"
                     [(ngModel)]="newSurvey.phoneNumber"
                     name="phoneNumber"
                     required
                     class="form-control focus-blue"
                     #phoneNumber="ngModel"
                     [ngClass]="{'error-border': phoneNumber.invalid && phoneNumber.touched, 'valid-border': phoneNumber.valid && phoneNumber.touched}"
                     maxlength="10"
                     (keydown)="validateNumberInput($event)"
                     (paste)="onPaste($event)"
                     [ngModelOptions]="{ updateOn: 'blur' }"
                     [pattern]="'^[0-9]*$'" 
                     minlength="10">
          
              <!-- Validation Messages -->
              <div *ngIf="phoneNumber.invalid && phoneNumber.touched">
                <small *ngIf="phoneNumber.errors?.required" class="error-message-email">Please enter your phone number</small>
                <small *ngIf="phoneNumber.errors?.minlength" class="error-message-email">Please enter a valid phone number</small>
                <small *ngIf="phoneNumber.errors?.pattern" class="error-message-email">Phone number can only contain digits</small>
              </div>
            </div>          
        </div>
        
        <!-- assign to top -->
        
        <div class="username"> 
          <!-- Email Address -->
          <!-- <p class="text-title-2">Email</p> -->
          <input type="email" placeholder="Enter your email" [(ngModel)]="newSurvey.emailAddress" name="email" required class="form-control focus-blue" #email="ngModel" pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$" [ngClass]="{'error-border': email.invalid && email.touched, 'valid-border': email.valid && email.touched}">
          
          <!-- Validation Email -->
          <div *ngIf="email.invalid && email.touched">
            <small *ngIf="email.errors?.required" class="error-message">Please enter your email</small>
            <small *ngIf="email.errors?.pattern" class="error-message">Please enter a valid email address</small>
          </div>
        </div>
          
          <!-- SELECTION PRODUCT -->
          
          <!-- <h5 class="text-title">What service do you use?</h5> -->
          
          <div class="selection-box">
            <div class="service-box">

              <h5 class="text-title">Do you ever use BRICK? Please select the service first?</h5>
              
              <select [(ngModel)]="newSurvey.financingType" (ngModelChange)="onServiceChange(newSurvey.financingType)" name="financingType" required #serviceType="ngModel" class="select-service" [ngClass]="{'error-border': personalFinancingType.invalid && personalFinancingType.touched, 'valid-border': personalFinancingType.valid && personalFinancingType.touched}">
                <option value="" >Select a service</option> <!-- Placeholder option -->
                <option value="Personal Financing-i">Personal Financing-i</option>
                <option value="Home Financing-i">Home Financing-i</option>
                <option value="Vehicle Financing">Vehicle Financing</option>
                <option value="Takaful">Takaful</option>
                <option value="Saving-i">Saving-i</option>
                <option value="Pawn Broking-i">Pawn Broking-i</option>
                <option value="Credit Card-i">Credit Card-i</option>
              </select>
              
              <!-- Validation ServiceType -->
              <div *ngIf="serviceType.invalid && serviceType.touched">
                <small *ngIf="serviceType.errors?.required" class="error-message">Please choose the service type</small>
              </div>
            </div>

            <div class="service-box">
              <div *ngIf="newSurvey.financingType">
                <h5 class="text-title">Choose a product based on the selected service</h5>
                <select [(ngModel)]="newSurvey.prodId" name="product" class="select-service" required #productType="ngModel">
                  <option value="">Selected Product</option>
                  <option *ngFor="let product of filteredProducts" [ngValue]="product.prodId">
                    {{ product.productName }}
                  </option>
                </select>
            
                <!-- Validation Product -->
                <div *ngIf="productType.invalid && productType.touched">
                  <small *ngIf="productType.errors?.required" class="error-message">Please choose the product</small>
                </div>
              </div>
            </div>
            
            
          </div>
             
        <div class="rating-box">

          <p class="text-title-2-rating">How would you rate our service?</p>
          <div class="rating">
            <input id="rating1" type="radio" name="rating" [(ngModel)]="newSurvey.starRating" value="1" required>
            <label for="rating1">1</label>
            
            <input id="rating2" type="radio" name="rating" [(ngModel)]="newSurvey.starRating" value="2" required>
            <label for="rating2">2</label>
            
            <input id="rating3" type="radio" name="rating" [(ngModel)]="newSurvey.starRating" value="3" required>
            <label for="rating3">3</label>
            
            <input id="rating4" type="radio" name="rating" [(ngModel)]="newSurvey.starRating" value="4" required>
            <label for="rating4">4</label>
            
            <input id="rating5" type="radio" name="rating" [(ngModel)]="newSurvey.starRating" value="5" required>
            <label for="rating5">5</label>
          </div>
          
          <!-- Show an error if the rating is not selected when submitting -->
          <!-- <div *ngIf="newSurvey.starRating == 0" class="error-message">
            <p>Please rate our services.</p>
          </div> -->
          
          <p class="text-title-2">Your Rating: {{ newSurvey.starRating }}</p>
          
        </div>

              
        <p class="text-title-2">Leave a comment for us</p>

        <!-- Predefined Comments -->
        <div class="predefined-comments">
          <div 
            class="select-cmnt" 
            *ngFor="let option of predefinedComments" 
            [class.selected] = "option === newSurvey.comment"
            (click)="selectPredefinedComment(option)" required>
            {{ option }} 
          </div>
          <div class="select-cmnt" (click)="toggleCommentBox()">More...</div>
        </div>
        
        <!-- Custom Comment Box -->
        <div class="username" *ngIf="showCommentBox">
          <textarea 
            type="text" 
            [(ngModel)]="newSurvey.comment" 
            (ngModelChange)="clearPredefinedComment()" 
            placeholder="Write your comment here..." 
            name="comment" 
            class="form-control focus-blue" 
            required 
            #comment="ngModel"
            [ngClass]="{'error-border': comment.invalid && comment.touched, 'valid-border': comment.valid && comment.touched}">
          </textarea>
        
          <!-- Validation for Comment -->
          <div *ngIf="comment.invalid && comment.touched">
            <small *ngIf="comment.errors?.required" class="error-message">
              Please enter your comment (use '-' if none).
            </small>
          </div>
        
          <!-- Character Count -->
          <div *ngIf="getCharacterCount() > 0">
            <div *ngIf="isCharacterLimitExceeded()">
              <small class="comment-count">
                Comment must be under 100 characters. Current character count: {{ getCharacterCount() }}
              </small>
            </div>
          </div>
        </div>
              
              <!-- Submit Button -->
              <button class="btn btn-primary btn-submit" type="submit">Submit</button>

            </form>
          </div>
        </main>
        
        <footer>
          Bank Rakyat
        </footer>
      </body>

      </span>










      <!-- admin view -->
      <span *ngIf="isUserAdmin || isUserOfficer">
        

        
        <div class="filter-box">
          <div class="all-btn-admin-survey-list">
            <button class="btn btn-primary btn-reset-filter" (click)="resetFilters()">Reset Filter</button>
            <button class="btn btn-primary btn-export" (click)="exportToExcel()">Export to Excel</button>
          </div>

          <input type="text" [(ngModel)]="searchText" placeholder="Search" class="form-control-search-2" [ngClass]="{'show': showAdvanceFilter}">
  <button (click)="toggleAdvanceFilter()" class="btn btn-primary advance-filter-btn" [ngClass]="{'active' : showAdvanceFilter}">
    Advance Filter
    <!-- Conditionally show arrow based on showAdvanceFilter -->
    <i *ngIf="showAdvanceFilter" class="fa fa-arrow-up arrow"></i>
    <i *ngIf="!showAdvanceFilter" class="fa fa-arrow-down arrow"></i>
  </button>

    <div class="advance-filter" [ngClass]="{'show': showAdvanceFilter}"  >
      

      <div class="filter-box-1" >
        <div class="all-filter-box">  
          <div class="all-filter-box-2">
            <div class="filter-box-2">
              <p>star</p>
              <select name="star" [(ngModel)]="selectedStarRating" (change)="loadSurveys()">
                <option value="" disabled selected>Star Rating</option>
                <option value="">All</option>
                <option [ngValue]="1">1 Star</option>
                <option [ngValue]="2">2 Stars</option>
                <option [ngValue]="3">3 Stars</option>
                <option [ngValue]="4">4 Stars</option>
                <option [ngValue]="5">5 Stars</option>
              </select> 
            </div>
            <div class="filter-box-2">
        </div>
      </div>  
    </div>

    
    <div class="all-filter-box" >
      <p>Service</p>
      <select [(ngModel)]="selectedFinancingType" (ngModelChange)="onServiceChange(selectedFinancingType)" name="financingType" required #serviceType="ngModel" [ngClass]="{'error-border': personalFinancingType.invalid && personalFinancingType.touched, 'valid-border': personalFinancingType.valid && personalFinancingType.touched}">
        <option value="" disabled>Select a service</option> <!-- Placeholder option -->
        <option value="Personal Financing-i">Personal Financing-i</option>
        <option value="Home Financing-i">Home Financing-i</option>
        <option value="Vehicle Financing">Vehicle Financing</option>
        <option value="Takaful">Takaful</option>
        <option value="Saving-i">Saving-i</option>
        <option value="Pawn Broking-i">Pawn Broking-i</option>  
        <option value="Credit Card-i">Credit Card-i</option>
      </select>      
    </div>
    
    <div class="all-filter-box" *ngIf="selectedFinancingType" >
            <p>Product</p>
            <select [(ngModel)]="selectedProductReal" name="product" required #productType="ngModel" (ngModelChange)="onProductChange()">
              <option value="">All</option>
              <option *ngFor="let product of filteredProducts" [ngValue]="product">
                {{ product.productName }}
              </option>
            </select>
          </div>
        </div>
        
        <div class="filter-box-1">  
          <div class="all-filter-box-date">
            <p>from</p>
            <input class="date-input" type="date" bsdatepicker class="date-input-from" placeholder="from" [(ngModel)]="startDate" (change)="loadSurveys()">
            <p class="date-input-from">to</p>
            <input class="date-input" type="date" bsdatepicker class="date-input-from" placeholder="to" [(ngModel)]="endDate" (change)="loadSurveys()">
          </div>
          
          <div class="all-filter-box-date">
            <input type="text" [(ngModel)]="searchText" placeholder="Search" class="form-control-search">
          </div>
        </div>  
      </div>
    
    </div>
      
      
      
    <div class="page-control">
      <!-- Previous Button -->
      <button (click)="goToFirstPage()" 
              class="btn btn-primary btn-page" 
              [disabled]="currentPage === 1">
        <!-- <i class="fa fa-step-backward" alt="Go to first page"></i> -->
        <<  
      </button>
      <button (click)="previousPage()" 
              class="btn btn-primary btn-page" 
              [disabled]="currentPage === 1">
        <!-- <i class="fa fa-arrow-left" alt="Go to previous page"></i> -->
        <
      </button>
    
      <!-- Page Number Buttons -->
      <button *ngFor="let page of visiblePages" 
              (click)="goToPage(page)" 
              [class.active]="page === currentPage" 
              class="btn btn-primary btn-page">
        {{ page }}
      </button>
    
      <!-- Next Button -->
      <button (click)="nextPage()" 
              class="btn btn-primary btn-page" 
              [disabled]="currentPage === totalPage">
        <!-- <i class="fa fa-arrow-right" alt="Go to next page"></i> -->
         >
      </button>
      <button (click)="goToLastPage()" 
              class="btn btn-primary btn-page" 
              [disabled]="currentPage === totalPage">
        <!-- <i class="fa fa-step-forward" alt="Go to last page"></i> -->
        >>
      </button>
    </div>
      

      <!-- survey form list --> 
<div class="survey-list">
  <div class="table-container">
      <table>
          <thead>
              <tr class="survey-list-admin">
                  <th>Action</th>
                  <th>Submission Date</th>
                  <th>Name</th>
                  <th>Email Address</th>
                  <th>Phone Number</th>
                  <th>Service Type</th>
                  <th>Product Selection</th>
                  <th>Comment</th>
                  <th>Star Rating 
                    <button (click)="sortSurveys('asc')" [class.active]="sortOrder === 'asc'" title="Sort Low to High" class="sort-btn">
                      <!-- <i class="fa fa-arrow-up"></i>  -->up
                    </button>
                    <button (click)="sortSurveys('desc')" [class.active]="sortOrder === 'desc'" title="Sort High to Low" class="sort-btn">
                      <!-- <i class="fa fa-arrow-down"></i> -->down
                    </button>
                  </th>
                  
              </tr>
          </thead>
          <tbody>
            
            <tr *ngFor="let survey of pageinatedSurveys; let i = index" class="table-hover">
              <td>
                <div class="dropdown">
                  <button class="btn btn-primary btn-edit" (click)="toggleAction(survey.id)">
                    Action
                  </button>
                  <ul class="dropdown-menu" *ngIf="isDropdown === survey.id">
                    <li><a (click)="viewUpdate(survey)" class="view-survey">View</a></li>
                  </ul>
                </div>
              </td>
              <td>{{ survey.submissionDate | date: 'dd/MM/yyyy' }}</td>
              <td>{{ survey.name }}</td>
              <td>{{ survey.emailAddress }}</td>
              <td>{{ survey.phoneNumber }}</td>
              <td>{{ survey.financingType }}</td>
              <td >{{ getProductNameById(survey.prodId)}}</td>
              <td>
                <div class="comment-section">
                  <textarea name="" id="" readonly class="form-control comment-area">{{ survey.comment || 'No Comment' }}</textarea>
                </div>
              </td>
              <td>{{ survey.starRating }}</td>
            </tr>
            
            
          </tbody>
          <tbody *ngIf="filteredSurveys.length === 0">
            <tr>
              <td colspan="10"><p style="font-size: 17px; margin-top: 10px;">No Results Found</p></td>
            </tr>
          </tbody>
            <td colspan="10" class="total-text-table" *ngIf="filteredSurveys.length > 0">Total {{totalSearch}}</td>
      </table>
    </div>
</div>



 <!-- real -->

    <div *ngIf="updateSurvey">

      <div class="card-overlay">
        <div class="card">
          
          <button (click)="close()" class="x-button">X</button>
      
          <!-- <button class="btn btn-primary edit-survey-button" (click)="toggleEdit()">edit</button> -->
          <div id="content">
      
            <h4>Survey Details</h4>
            <div class="box-one">
              <div class="user-detail-box">
                <label class="title-user-detail">Username</label>
                <input type="text" class="form-control user-detail"  value="{{updateSurvey.name}}" readonly>
              </div>
              <div class="user-detail-box">
          <label class="title-user-detail">Email</label>
          <input type="text" class="form-control user-detail" value="{{updateSurvey.emailAddress}}" readonly>
        </div>
      </div>
      <div class="box-one">
        <div class="user-detail-box">
          <label class="title-user-detail">Phone Number</label>
          <input type="text" class="form-control user-detail"  value="{{updateSurvey.phoneNumber}}" readonly>
        </div>
        <div class="user-detail-box">
          <label class="title-user-detail">Star Rating</label>
          <input type="text" class="form-control user-detail"  value="{{updateSurvey.starRating}}" readonly>
        </div>
      </div>
      <div class="box-one">
        <div class="user-detail-box">
          <label class="title-user-detail">Service Type</label>
          <input type="text" class="form-control user-detail" value="{{updateSurvey.financingType}}" readonly>
        </div>
        <div class="user-detail-box">
          <label class="title-user-detail">Product Selection</label>
          <input type="text" class="form-control user-detail"  value="{{ getProductNameById(updateSurvey.prodId) }}" [readonly]="!surveyEdit">
        </div>
        
        <input *ngIf="surveyEdit" type="button" value="click me">
      
      </div>
      <div class="box-one">
        <div class="user-detail-box">
          <label class="title-user-detail">Submission Date</label>
          <input type="text" class="form-control user-detail" value="{{updateSurvey.submissionDate | date: 'dd/MM/yyyy'}}" readonly>
        </div>
        <div class="user-detail-box">
          <label class="title-user-detail">Comment</label>
          <textarea class="form-control comment-area-view user-detail" value="{{updateSurvey.comment}}" readonly></textarea>
        </div>
      </div>
      </div>
      <div class="box-one">
        <button (click)="generatePdf()" class="btn btn-primary">Print</button>
        <button (click)="deleteSurvey(updateSurvey.id)" class="btn btn-danger" *ngIf="isUserAdmin" >Delete</button>
      </div>  
      </div>
      </div>
</div>


  

  

</span>

