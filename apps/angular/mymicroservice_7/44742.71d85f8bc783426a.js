"use strict";(self.webpackChunkmymicroservice_7=self.webpackChunkmymicroservice_7||[]).push([[44742],{44742:(ft,b,c)=>{c.r(b),c.d(b,{ChatComponent:()=>M,ChatContactDto:()=>ot,ChatContactsComponent:()=>u,ChatConversationDto:()=>at,ChatMessageDto:()=>it,ChatMessageSide:()=>m,ChatMessageTitleComponent:()=>f,ChatModule:()=>ut,ChatTargetUserInfo:()=>rt,ContactService:()=>E,ConversationAvatarComponent:()=>C,ConversationService:()=>mt,GetConversationInput:()=>ct,MarkConversationAsReadInput:()=>lt,SendMessageInput:()=>dt,SendOnEnterSettingDto:()=>ht,SettingsService:()=>_t,getContactName:()=>_});var r=c(30791),D=c(39862),t=c(93953),x=c(58780),T=c(89079),k=c(96697),R=c(33726),O=c(70152),I=c(70980),P=c(99437),d=c(49741),y=c(26493),g=c(60177),p=c(89417),l=c(15306);const S=(n,a)=>a.userId,j=n=>({"min-height":n}),w=(n,a)=>({$implicit:n,index:a});function F(n,a){if(1&n){const e=t.RV6();t.j41(0,"input",11),t.nI1(1,"abpLocalization"),t.nI1(2,"abpLocalization"),t.mxI("ngModelChange",function(s){t.eBV(e);const i=t.XpG();return t.DH7(i.filter,s)||(i.filter=s),t.Njj(s)}),t.bIt("input.debounce",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.typing())}),t.k0s()}if(2&n){const e=t.XpG();t.R50("ngModel",e.filter),t.Y8G("placeholder",t.bMT(1,3,"Chat::SearchInContacts")),t.BMQ("aria-label",t.bMT(2,5,"Chat::SearchInContacts"))}}function B(n,a){if(1&n&&t.eu8(0,9),2&n){const e=a.$implicit,o=a.$index;t.XpG();const s=t.sdS(14);t.Y8G("ngTemplateOutlet",s)("ngTemplateOutletContext",t.l_i(2,w,e,o))}}function $(n,a){1&n&&(t.j41(0,"div",10)(1,"small"),t.EFF(2),t.nI1(3,"abpLocalization"),t.k0s()()),2&n&&(t.R7$(2),t.JRh(t.bMT(3,1,"Chat::OtherContacts")))}function G(n,a){if(1&n&&t.eu8(0,9),2&n){const e=a.$implicit,o=a.$index;t.XpG();const s=t.sdS(14);t.Y8G("ngTemplateOutlet",s)("ngTemplateOutletContext",t.l_i(2,w,e,o))}}function N(n,a){if(1&n&&(t.j41(0,"small",18),t.EFF(1),t.k0s()),2&n){const e=t.XpG().$implicit;t.R7$(),t.JRh(e.unreadMessageCount)}}function L(n,a){if(1&n){const e=t.RV6();t.j41(0,"div",21)(1,"button",22),t.nrm(2,"i",23),t.k0s(),t.j41(3,"div",24)(4,"button",25),t.bIt("click",function(){t.eBV(e);const s=t.XpG().$implicit,i=t.XpG();return t.Njj(i.deleteConversation(s))}),t.EFF(5,"Delete"),t.k0s()()()}}function A(n,a){if(1&n){const e=t.RV6();t.j41(0,"a",12),t.bIt("click",function(){const s=t.eBV(e).$implicit,i=t.XpG();return t.Njj(i.selectContact(s))}),t.j41(1,"div",13),t.nrm(2,"abp-conversation-avatar",14),t.j41(3,"div",15)(4,"div",16)(5,"h5",17),t.DNE(6,N,2,1,"small",18),t.EFF(7),t.k0s(),t.j41(8,"small",19),t.EFF(9),t.nI1(10,"date"),t.k0s()(),t.j41(11,"p",20),t.EFF(12),t.nI1(13,"slice"),t.k0s(),t.DNE(14,L,6,0,"div",21),t.k0s()()()}if(2&n){const e=a.$implicit,o=t.XpG();t.AVh("active",(null==o.selectedContact?null:o.selectedContact.userId)===e.userId),t.R7$(2),t.Y8G("contact",e),t.R7$(4),t.vxM(e.unreadMessageCount?6:-1),t.R7$(),t.SpI(" ",o.getContactName(e)," "),t.R7$(2),t.JRh(t.i5U(10,8,e.lastMessageDate,"HH:mm")),t.R7$(3),t.SpI(" ",(null==e.lastMessage?null:e.lastMessage.length)>24?t.brH(13,11,e.lastMessage,0,23)+"...":e.lastMessage," "),t.R7$(2),t.vxM(o.conversationDeletable?14:-1)}}const U=["chatBox"],W=(n,a)=>a.messageDate,X=n=>({isSender:n});function H(n,a){1&n&&(t.EFF(0),t.nI1(1,"abpLocalization")),2&n&&t.SpI(" ",t.bMT(1,1,"Chat::YouHaveAnUnreadMessage")," ")}function z(n,a){if(1&n&&(t.EFF(0),t.nI1(1,"abpLocalization")),2&n){const e=t.XpG(4);t.SpI(" ",t.i5U(1,1,"Chat::YouHave{0}UnreadMessages",""+e.unreadMessageCount)," ")}}function K(n,a){if(1&n&&(t.j41(0,"div",19)(1,"h3")(2,"span",21),t.DNE(3,H,2,3)(4,z,2,4),t.k0s()()()),2&n){const e=t.XpG(3);t.R7$(3),t.vxM(1===e.unreadMessageCount?3:4)}}function Q(n,a){if(1&n){const e=t.RV6();t.j41(0,"div",26)(1,"button",27),t.nrm(2,"i",28),t.k0s(),t.j41(3,"div",29)(4,"button",30),t.bIt("click",function(){t.eBV(e);const s=t.XpG(2).$implicit,i=t.XpG(2);return t.Njj(i.deleteMessage(s))}),t.EFF(5),t.nI1(6,"abpLocalization"),t.k0s()()()}2&n&&(t.R7$(5),t.SpI(" ",t.bMT(6,1,"AbpUi::Delete")," "))}function V(n,a){if(1&n){const e=t.RV6();t.j41(0,"div",26)(1,"button",31),t.nrm(2,"i",28),t.k0s(),t.j41(3,"div",29)(4,"button",30),t.bIt("click",function(){t.eBV(e);const s=t.XpG(2).$implicit,i=t.XpG(2);return t.Njj(i.deleteMessage(s))}),t.EFF(5),t.nI1(6,"abpLocalization"),t.k0s()()()}2&n&&(t.R7$(5),t.SpI(" ",t.bMT(6,1,"AbpUi::Delete")," "))}function Y(n,a){if(1&n&&(t.j41(0,"div",22)(1,"div",23)(2,"div",24),t.nrm(3,"p",25),t.k0s(),t.j41(4,"p"),t.EFF(5),t.nI1(6,"date"),t.k0s(),t.DNE(7,Q,7,3,"div",26)(8,V,7,3,"div",26),t.k0s()()),2&n){const e=a,o=t.XpG().$implicit,s=t.XpG(2);t.AVh("ms-auto",e.isSender),t.R7$(2),t.AVh("bg-primary",e.isSender)("bg-light",!e.isSender),t.R7$(),t.ZvI("message-text text-small mb-0 ",e.isSender?"text-white":"text-muted",""),t.Y8G("innerHTML",o.message,t.npT),t.R7$(),t.ZvI("message-date small text-muted m-0 ",e.isSender?"left":"right",""),t.R7$(),t.SpI(" ",t.i5U(6,16,o.messageDate,s.getDateFormat(o.messageDate))," "),t.R7$(2),t.vxM(s.messageDeletable&&o.side===s.chatMessageSide.Sender?7:-1),t.R7$(),t.vxM(s.messageDeletableWithPeriod&&s.showDeleteDropdown(o)&&o.side===s.chatMessageSide.Sender?8:-1)}}function J(n,a){if(1&n&&t.DNE(0,K,5,1,"div",19)(1,Y,9,19,"div",20),2&n){let e;const o=a.$implicit,s=a.$index,i=t.XpG(2);t.vxM(i.selectedContactMessages.length-i.unreadMessageCount===s?0:-1),t.R7$(),t.vxM((e=t.eq3(2,X,o.side===i.chatMessageSide.Sender))?1:-1,e)}}function Z(n,a){1&n&&t.nrm(0,"i",39)}function q(n,a){1&n&&t.nrm(0,"i",40)}function tt(n,a){if(1&n){const e=t.RV6();t.j41(0,"div",18)(1,"div",32)(2,"textarea",33),t.nI1(3,"abpLocalization"),t.mxI("ngModelChange",function(s){t.eBV(e);const i=t.XpG(2);return t.DH7(i.message,s)||(i.message=s),t.Njj(s)}),t.bIt("keydown.enter",function(s){t.eBV(e);const i=t.XpG(2);return t.Njj(i.sendWithEnter(s))}),t.k0s(),t.j41(4,"div",34)(5,"input",35),t.mxI("ngModelChange",function(s){t.eBV(e);const i=t.XpG(2);return t.DH7(i.sendOnEnter,s)||(i.sendOnEnter=s),t.Njj(s)}),t.k0s(),t.j41(6,"label",36),t.EFF(7),t.nI1(8,"abpLocalization"),t.k0s()(),t.j41(9,"div",37)(10,"button",38),t.bIt("click",function(){t.eBV(e);const s=t.XpG(2);return t.Njj(s.send())}),t.EFF(11),t.nI1(12,"abpLocalization"),t.DNE(13,Z,1,0,"i",39)(14,q,1,0,"i",40),t.k0s()()()()}if(2&n){const e=t.XpG(2);t.R7$(2),t.Y8G("placeholder",t.bMT(3,7,"Chat::TypeMessage")),t.R50("ngModel",e.message),t.R7$(3),t.R50("ngModel",e.sendOnEnter),t.R7$(2),t.JRh(t.bMT(8,9,"Chat::SendOnEnter")),t.R7$(3),t.Y8G("disabled",!e.message),t.R7$(),t.SpI(" ",t.bMT(12,11,"Chat::Send")," "),t.R7$(2),t.vxM(e.loading?14:13)}}function et(n,a){if(1&n&&(t.j41(0,"div",13),t.nrm(1,"abp-chat-message-title",15),t.j41(2,"div",16,0)(4,"div",17),t.Z7z(5,J,2,4,null,null,W),t.k0s()(),t.DNE(7,tt,15,13,"div",18),t.k0s()),2&n){const e=t.XpG();t.R7$(),t.Y8G("selectedContact",e.selectedContact),t.R7$(4),t.Dyx(e.selectedContactMessages),t.R7$(2),t.vxM(null!=e.selectedContact&&e.selectedContact.userId?7:-1)}}function nt(n,a){if(1&n){const e=t.RV6();t.j41(0,"div",14),t.nrm(1,"i",41),t.j41(2,"p"),t.EFF(3),t.nI1(4,"abpLocalization"),t.k0s(),t.j41(5,"button",42),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.startConversation())}),t.EFF(6),t.nI1(7,"abpLocalization"),t.k0s()()}2&n&&(t.R7$(3),t.JRh(t.bMT(4,2,"Chat::NoMessageYetMessage")),t.R7$(3),t.SpI(" ",t.bMT(7,4,"Chat::StartConversation")," "))}var m=function(n){return n[n.Sender=1]="Sender",n[n.Receiver=2]="Receiver",n}(m||{});let E=(()=>{class n{constructor(e){this.restService=e,this.apiName="Chat"}getContactsByInput(e={}){return this.restService.request({url:"/api/chat/contact/contacts",method:"GET",params:e},{apiName:this.apiName})}static{this.\u0275fac=function(o){return new(o||n)(t.KVO(r.G9T))}}static{this.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();class ot{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}const st=[{color:"#ffffff",backgroundColor:"#3cb160"},{color:"#ffffff",backgroundColor:"#c373cc"},{color:"#ffffff",backgroundColor:"#2b78b3"},{color:"#ffffff",backgroundColor:"#6ac79a"},{color:"#ffffff",backgroundColor:"#aeb140"},{color:"#ffffff",backgroundColor:"#b773c0"},{color:"#ffffff",backgroundColor:"#e16d7a"},{color:"#ffffff",backgroundColor:"#ffac2a"},{color:"#ffffff",backgroundColor:"#21bbc7"},{color:"#ffffff",backgroundColor:"#59ab95"}];let C=(()=>{class n{get avatarText(){if(this.contact&&this.contact.username)return this.contact.name&&this.contact.surname?this.contact.name[0]+this.contact.surname[0]:this.contact.name?this.contact.name.slice(0,2):this.contact.username.slice(0,2)}get avatarBgStyle(){if(!this.contact||!this.contact.username)return;let e=0;for(let o=0;o<this.contact.username.length;o++)e=this.contact.username.charCodeAt(o)+((e<<5)-e);return st[Math.abs(e%10)]}get isSmall(){return"string"==typeof this.small||this.small}static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275cmp=t.VBU({type:n,selectors:[["abp-conversation-avatar"]],inputs:{contact:"contact",small:"small"},decls:2,vars:4,consts:[[1,"avatar","me-2","float-start","rounded-circle",3,"ngStyle"]],template:function(o,s){1&o&&(t.j41(0,"div",0),t.EFF(1),t.k0s()),2&o&&(t.AVh("small",s.isSmall),t.Y8G("ngStyle",s.avatarBgStyle),t.R7$(),t.SpI(" ",s.avatarText," "))},dependencies:[g.B3],styles:[".avatar[_ngcontent-%COMP%]{height:48px;width:48px;line-height:48px;font-size:16px;font-weight:700;text-align:center;text-transform:uppercase}.avatar.small[_ngcontent-%COMP%]{height:36px;width:36px;line-height:37px;font-size:14px}"]})}}return n})(),u=(()=>{class n{#t;get contacts(){return this.allContacts.filter(e=>e.lastMessage).sort((e,o)=>new Date(e.lastMessageDate).valueOf()>new Date(o.lastMessageDate).valueOf()?-1:1)}get otherContacts(){return this.allContacts.filter(e=>!e.lastMessage)}listenToNewMessages(){this.subscription.addOne(this.chatConfigService.message$,(e={})=>{const o=this.allContacts.findIndex(i=>i.userId===e.senderUserId),s={userId:e.senderUserId,username:e.senderUsername,name:e.senderName,surname:e.senderSurname,lastMessage:e.text,unreadMessageCount:1,lastMessageDate:new Date,lastMessageSide:m.Receiver};o>-1?this.allContacts[o]={...s,unreadMessageCount:this.selectedContact.userId===this.allContacts[o].userId?0:this.allContacts[o].unreadMessageCount+1}:this.filter||this.allContacts.push(s)})}constructor(){this.contactService=(0,t.WQX)(E),this.chatConfigService=(0,t.WQX)(y.a8),this.subscription=(0,t.WQX)(r.nCQ),this.chatConversationService=(0,t.WQX)(d.rP),this.startConversation=(0,t.geq)(),this.selected=new t.bkB,this.conversationDeleted=(0,t.CGW)(),this.allContacts=[],this.selectedContact={},this.filter="",this.getContactName=_,(0,t.QZP)(()=>{this.startConversation()&&(this.#t=this.startConversation(),this.filter=void 0,this.get(null,!0))})}ngOnInit(){this.selectContact(this.allContacts.length?this.allContacts[0]:{}),this.listenToNewMessages()}typing(){this.filter||!this.#t?this.filter?this.get(()=>{this.startConversation.set(!1)},!0):!this.filter&&!this.#t&&(this.allContacts=[]):this.get(null,!0)}get(e,o){const i="boolean"==typeof o?o:!!this.filter;this.filter=this.filter?.trim(),this.contactService.getContactsByInput({includeOtherContacts:i,filter:this.filter}).subscribe(h=>{this.allContacts=h,e&&e()})}selectContact(e){this.selectedContact=e,this.selected.emit(e)}changeLastMessageOfSelectedContact(e){this.selectedContact.lastMessage=e,this.selectedContact.lastMessageDate=new Date;const o=this.allContacts.findIndex(s=>s.userId===this.selectedContact.userId);this.allContacts[o]=this.selectedContact}markSelectedContactAsRead(){this.selectedContact.unreadMessageCount=0}deleteConversation(e){this.chatConversationService.deleteConversation({targetUserId:e.userId}).pipe((0,k.s)(1)).subscribe(()=>{this.conversationDeleted.emit(e),this.selectedContact=null,this.get(null,!0)})}static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275cmp=t.VBU({type:n,selectors:[["abp-chat-contacts"]],inputs:{conversationDeletable:"conversationDeletable",startConversation:[1,"startConversation"]},outputs:{startConversation:"startConversationChange",selected:"selected",conversationDeleted:"conversationDeleted"},features:[t.Jv_([r.nCQ])],decls:15,vars:5,consts:[["contactTemplate",""],[1,"card","w-100","mb-3","mb-md-0"],[1,"card-body","p-1","p-md-2","p-lg-3"],[1,"mb-2","rounded-2"],[1,"row"],[1,"col"],["id","contacts-filter","type","search","class","form-control form-control","autocomplete","off","spellcheck","false",3,"ngModel","placeholder","ngModelChange","input.debounce",4,"abpPermission"],[1,"messages-box","m-0","p-0"],["id","contact-list",1,"list-group","rounded-3",3,"ngStyle"],[3,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"list-group-item","px-2","py-1","bg-light","text-muted","text-center","font-size-sm","text-uppercase","border-start-0","border-end-0"],["id","contacts-filter","type","search","autocomplete","off","spellcheck","false",1,"form-control","form-control",3,"ngModelChange","input.debounce","ngModel","placeholder"],[1,"chat-contact","list-group-item","list-group-item-action","cursor-pointer","position-relative","px-2","border-2","rounded-2","mb-1","mt-0",3,"click"],[1,"media"],[3,"contact"],[1,"media-body","ms-2"],[1,"d-flex","align-items-center","justify-content-between","mb-0"],[1,"mb-0","mt-1"],[1,"badge","badge-success","me-1"],[1,"last-message-date"],[1,"mb-0","small","last-message"],["ngbDropdown","",1,"dropdown","position-absolute","bottom-0","end-0"],["id","dropdownBasic1","ngbDropdownToggle","",1,"btn","p-1","down-arrow"],[1,"bi","bi-chevron-down"],["ngbDropdownMenu",""],["ngbDropdownItem","",3,"click"]],template:function(o,s){1&o&&(t.j41(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div",5),t.DNE(5,F,3,7,"input",6),t.k0s()()(),t.j41(6,"div",7)(7,"div",8),t.Z7z(8,B,1,5,"ng-container",9,S),t.DNE(10,$,4,3,"div",10),t.Z7z(11,G,1,5,"ng-container",9,S),t.k0s()()()(),t.DNE(13,A,15,15,"ng-template",null,0,t.C5r)),2&o&&(t.R7$(5),t.Y8G("abpPermission","Chat.Searching"),t.R7$(2),t.Y8G("ngStyle",t.eq3(3,j,s.allContacts.length&&"calc(100vh - 254.34px)")),t.R7$(),t.Dyx(s.contacts),t.R7$(2),t.vxM(s.otherContacts.length?10:-1),t.R7$(),t.Dyx(s.otherContacts))},dependencies:[g.T3,g.B3,p.me,p.BC,p.vS,r.$Is,r.Dud,l.tg,l.do,l.U0,l._H,l.Eu,C,g.P9,g.vh,r.aM3],styles:[".messages-box[_ngcontent-%COMP%]{overflow-y:scroll;max-height:calc(100vh - 254.34px)}.dropdown-toggle[_ngcontent-%COMP%]:after{display:none}.dropdown[_ngcontent-%COMP%]{border-color:transparent}.down-arrow[_ngcontent-%COMP%]{border:none;opacity:0}.media[_ngcontent-%COMP%]:hover   .down-arrow[_ngcontent-%COMP%]{opacity:100%}.list-group[_ngcontent-%COMP%]{padding-right:7px}[_ngcontent-%COMP%]::-webkit-scrollbar{width:5px}[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--lpx-border-color)}"]})}}return n})();function _({name:n,surname:a,username:e}){return n||a?`${n||""} ${a||""}`:e}class at{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}class it{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}class rt{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}class ct extends r.l2l{constructor(a={}){super(a)}}class lt{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}class dt{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}class ht{constructor(a={}){if(a)for(const e in a)a.hasOwnProperty(e)&&(this[e]=a[e])}}let f=(()=>{class n{get contactName(){return _(this.selectedContact||{})}static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275cmp=t.VBU({type:n,selectors:[["abp-chat-message-title"]],inputs:{selectedContact:"selectedContact"},decls:8,vars:2,consts:[[1,"px-2","py-1","border","mb-2","rounded-2"],[1,"row"],[1,"col-auto","py-1","pe-0"],["small","",3,"contact"],[1,"col","d-flex","flex-column","justify-content-center"],["id","conversation-title",1,"m-0"],["id","conversation-info"]],template:function(o,s){1&o&&(t.j41(0,"div",0)(1,"div",1)(2,"div",2),t.nrm(3,"abp-conversation-avatar",3),t.k0s(),t.j41(4,"div",4)(5,"h5",5),t.EFF(6),t.k0s(),t.nrm(7,"small",6),t.k0s()()()),2&o&&(t.R7$(3),t.Y8G("contact",s.selectedContact),t.R7$(3),t.JRh(s.contactName))},dependencies:[C],encapsulation:2})}}return n})();const v=new Date,pt=new Date(v.getFullYear(),v.getMonth(),v.getDate()).valueOf();let M=(()=>{class n{#t;get selectedContactMessages(){return this.userMessages.get(this.selectedContact.userId)||[]}addFilterToHttpWaitService(){this.httpWaitService.addFilter([{method:"POST",endpoint:"/api/chat/conversation/send-message"},{method:"GET",endpoint:"/api/chat/contact/contacts"}])}listenToChatBoxScroll(){this.chatBoxRef&&(0,R.R)(this.chatBoxRef.nativeElement,"scroll").pipe((0,O.B)(150),(0,T.pQ)(this.#t)).subscribe(this.onScroll)}listenToNewMessages(){this.chatConfigService.message$.pipe((0,T.pQ)(this.#t)).subscribe(({senderUserId:e,text:o}={})=>{if(!this.userMessages.has(e))return;const s=this.selectedContact.userId===e;this.userMessages.get(e).push({message:o,messageDate:Date(),side:d.LD.Receiver,isRead:s,readDate:s?Date():null}),this.scrollToEnd()})}init(){this.configState.getSettings$("Volo.Chat.Messaging").subscribe(e=>{const o=d.$K.find(i=>i.key===e["Volo.Chat.Messaging.DeletingMessages"]).value,s=d.N4.find(i=>i.key===e["Volo.Chat.Messaging.DeletingConversations"]).value;this.conversationDeletable=o===d.V7.Enabled&&s===d.Lt.Enabled,this.messageDeletable=o===d.V7.Enabled,this.messageDeletableWithPeriod=o===d.V7.EnabledWithDeletionPeriod,this.messageDeletePeriod=Number(e["Volo.Chat.Messaging.MessageDeletionPeriod"])})}constructor(){this.#t=(0,t.WQX)(t.abz),this.conversationService=(0,t.WQX)(d.rP),this.chatConfigService=(0,t.WQX)(y.a8),this.configState=(0,t.WQX)(r.d14),this.httpWaitService=(0,t.WQX)(r.dHb),this.confirmation=(0,t.WQX)(D.td),this.selectedContact={},this.unreadMessageCount=0,this.userMessages=new Map,this.chatMessageSide=d.LD,this.clickedStartMessage=!1,this.conversationDeletable=!1,this.messageDeletable=!1,this.messageDeletableWithPeriod=!1,this.onScroll=e=>{this.allMessagesLoaded||this.pagingLoading||!this.selectedContact.lastMessage||this.chatBoxRef?.nativeElement.scrollTop>250||this.selectedContactMessages.length%50!=0?e.preventDefault():(this.pagingLoading=!0,this.conversationService.getConversation({skipCount:this.selectedContactMessages.length,maxResultCount:50,targetUserId:this.selectedContact.userId}).pipe((0,I.j)(()=>this.pagingLoading=!1)).subscribe(o=>{o.messages.length?this.userMessages.get(this.selectedContact.userId).unshift(...o.messages.reverse()):this.allMessagesLoaded=!0}))},this.init(),this.addFilterToHttpWaitService()}ngAfterViewInit(){this.sendOnEnter="false"!==(this.configState.getSetting("Volo.Chat.Messaging.SendMessageOnEnter")||"").toLowerCase(),this.listenToChatBoxScroll(),this.listenToNewMessages()}getConversation(e){this.allMessagesLoaded=!1,this.conversationService.getConversation({skipCount:0,maxResultCount:50,targetUserId:this.selectedContact.userId}).subscribe(o=>{this.userMessages.set(this.selectedContact.userId,o.messages.reverse()),e&&this.scrollToEnd(),this.selectedContact.unreadMessageCount&&this.markConversationAsRead()})}send(){!this.message||this.loading||(this.unreadMessageCount=0,this.loading=!0,this.conversationService.sendMessage({message:this.message,targetUserId:this.selectedContact.userId}).pipe((0,I.j)(()=>this.loading=!1)).subscribe(e=>{this.chatContactsComponent.changeLastMessageOfSelectedContact(this.message),this.userMessages.has(this.selectedContact.userId)||this.userMessages.set(this.selectedContact.userId,[]),this.userMessages.get(this.selectedContact.userId).push({...e}),this.message="",this.scrollToEnd()}))}markConversationAsRead(){this.conversationService.markConversationAsRead({targetUserId:this.selectedContact.userId}).subscribe(()=>{this.chatContactsComponent.markSelectedContactAsRead(),this.selectedContact.unreadMessageCount=0,setTimeout(()=>this.unreadMessageCount=0,5e3)})}sendWithEnter(e){this.sendOnEnter&&(e.preventDefault(),this.send())}onSelectContact(e){this.selectedContact=e,this.unreadMessageCount=e.unreadMessageCount,this.scrollToEnd(),!this.userMessages.has(e.userId)&&e.lastMessage?this.getConversation(!0):e.unreadMessageCount&&this.markConversationAsRead()}getDateFormat(e){return e=new Date(e),new Date(e.getFullYear(),e.getMonth(),e.getDate()).valueOf()===pt?"shortTime":"short"}scrollToEnd(){setTimeout(()=>{const{offsetTop:e}=document.querySelector(".unread-message-count-badge-wrapper")||{};this.chatBoxRef?.nativeElement.scrollTo({top:e?e-60:this.chatBoxRef.nativeElement.scrollHeight})},0)}startConversation(){this.clickedStartMessage=!0}deleteMessage(e){this.conversationService.deleteMessage({targetUserId:this.selectedContact.userId,messageId:e.id}).pipe((0,P.W)(o=>{const s=o.error.error;throw"Volo.Chat:010005"===s.code&&(s.data.seconds<=0?this.messageDeletableWithPeriod=!1:this.selectedContactMessages.find(i=>i.id===e.id).readDate=null),o})).subscribe({next:()=>{const o=this.userMessages.get(this.selectedContact.userId).filter(s=>s.id!==e.id);this.userMessages.set(this.selectedContact.userId,o)},error:o=>{const s=o.error?.error?.message;this.confirmation.warn(s,"AbpUi::Warning",{hideCancelBtn:!0,yesText:"AbpUi::Ok"})}})}showDeleteDropdown(e){const o=new Date(e.readDate).getTime();return!((new Date).getTime()-o>this.messageDeletePeriod)}conversationDeleted(e){this.selectedContact.userId===e.userId&&(this.selectedContact={},this.userMessages.delete(e.userId))}static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275cmp=t.VBU({type:n,selectors:[["abp-chat"]],viewQuery:function(o,s){if(1&o&&(t.GBs(U,5),t.GBs(u,5)),2&o){let i;t.mGM(i=t.lsd())&&(s.chatBoxRef=i.first),t.mGM(i=t.lsd())&&(s.chatContactsComponent=i.first)}},decls:14,vars:4,consts:[["chatBox",""],[1,"row","entry-row"],[1,"col-auto"],[1,"col-lg-auto","ps-lg-0"],[1,"col"],["id","AbpContentToolbar",1,"text-lg-end","pt-2"],["id","chat_wrapper"],[1,"container-fluid"],[1,"row"],[1,"col-12","col-md-5","col-lg-4","d-flex","align-items-stretch"],[1,"d-flex","w-100",3,"selected","startConversationChange","conversationDeleted","startConversation","conversationDeletable"],[1,"col-12","col-md-7","col-lg-8","d-flex","align-items-stretch"],[1,"card","w-100","mb-0"],[1,"card-body","p-1","p-md-2","p-lg-3"],[1,"card-body","pt-5","pb-5","text-center"],[3,"selectedContact"],["id","chat-conversation-wrapper",1,"chat-box","mb-2"],["id","chat-conversation",1,"chat-box-container"],["id","send-message-form",1,"bg-light","rounded-3","m-0"],[1,"row","justify-content-center","unread-message-count-badge-wrapper"],[1,"media","w-75","mw-65","w-lp-auto","mb-2",3,"ms-auto"],[1,"badge","badge-info"],[1,"media","w-75","mw-65","w-lp-auto","mb-2"],[1,"media-body","position-relative"],[1,"card","shadow-sm","rounded","py-1","px-2","py-lg-2","px-lg-3","mb-1"],[3,"innerHTML"],["ngbDropdown","",1,"dropdown","position-absolute","top-0","end-0"],["ngbDropdownToggle","",1,"btn","p-1","text-white","down-arrow"],[1,"bi","bi-chevron-down"],["ngbDropdownMenu",""],["ngbDropdownItem","",3,"click"],["ngbDropdownToggle","",1,"btn","p-1","text-light","down-arrow"],[1,"p-2","p-lg-3"],["id","chat-message-box","name","message","type","text",1,"form-control","rounded","py-2",3,"ngModelChange","keydown.enter","placeholder","ngModel"],[1,"form-check","float-start","mt-2"],["type","checkbox","id","send-on-enter",1,"form-check-input","border","shadow-sm",3,"ngModelChange","ngModel"],["for","send-on-enter",1,"form-check-label"],[1,"mt-2","text-end"],["id","send-message-button","type","button",1,"btn","btn-primary","px-3",3,"click","disabled"],["aria-hidden","true",1,"fa","fa-paper-plane","ms-2"],["aria-hidden","true",1,"fas","fa-spinner","fa-spin","ms-2"],["aria-hidden","true",1,"fa","fa-commenting-o","fs-2"],["type","button",1,"btn","btn-primary",3,"click"]],template:function(o,s){1&o&&(t.j41(0,"div",1),t.nrm(1,"div",2)(2,"div",3),t.j41(3,"div",4),t.nrm(4,"div",5),t.k0s()(),t.j41(5,"div",6)(6,"div",7)(7,"div",8)(8,"div",9)(9,"abp-chat-contacts",10),t.bIt("selected",function(h){return s.onSelectContact(h)}),t.mxI("startConversationChange",function(h){return t.DH7(s.clickedStartMessage,h)||(s.clickedStartMessage=h),h}),t.bIt("conversationDeleted",function(h){return s.conversationDeleted(h)}),t.k0s()(),t.j41(10,"div",11)(11,"div",12),t.DNE(12,et,8,2,"div",13)(13,nt,8,6,"div",14),t.k0s()()()()()),2&o&&(t.R7$(9),t.R50("startConversation",s.clickedStartMessage),t.Y8G("conversationDeletable",s.conversationDeletable),t.R7$(3),t.vxM(s.selectedContact.userId?12:-1),t.R7$(),t.vxM(s.selectedContact.userId?-1:13))},dependencies:[p.me,p.Zm,p.BC,p.vS,l.tg,l.do,l.U0,l._H,l.Eu,u,f,g.vh,r.aM3],styles:[".chat-box[_ngcontent-%COMP%]{height:calc(100vh - 390px);overflow-y:scroll}.message-text[_ngcontent-%COMP%]{white-space:pre-line}.message-date[_ngcontent-%COMP%]{position:absolute;opacity:.35;width:100px;top:1px}.message-date.left[_ngcontent-%COMP%]{left:-110px;text-align:right}.message-date.right[_ngcontent-%COMP%]{right:-110px}.dropdown-toggle[_ngcontent-%COMP%]:after{display:none}.dropdown[_ngcontent-%COMP%]{border-color:transparent}.down-arrow[_ngcontent-%COMP%]{border:none;opacity:0}.media-body[_ngcontent-%COMP%]:hover   .down-arrow[_ngcontent-%COMP%]{opacity:100%}.chat-box-container[_ngcontent-%COMP%]{padding-right:7px}[_ngcontent-%COMP%]::-webkit-scrollbar{width:5px}[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--lpx-border-color)}"]})}}return n})();const gt=[{path:"",component:r.Cs_,canActivate:[r.W_R,r.RH_],children:[{path:"",component:r.yFO,data:{requiredPolicy:"Chat.Messaging",replaceableComponent:{defaultComponent:M,key:"Chat.ChatComponent"},title:"Chat::Menu:Chat"}}]}];let Ct=(()=>{class n{static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275mod=t.$C({type:n})}static{this.\u0275inj=t.G2t({imports:[x.iI.forChild(gt),x.iI]})}}return n})(),ut=(()=>{class n{static forChild(){return{ngModule:n,providers:[]}}static forLazy(){return new r.l37(n.forChild())}static{this.\u0275fac=function(o){return new(o||n)}}static{this.\u0275mod=t.$C({type:n})}static{this.\u0275inj=t.G2t({imports:[r.Ui,D.Ts,Ct,l.zH]})}}return n})(),mt=(()=>{class n{constructor(e){this.restService=e,this.apiName="Chat"}sendMessageByInput(e){return this.restService.request({url:"/api/chat/conversation/send-message",method:"POST",body:e},{apiName:this.apiName})}getConversationByInput(e={}){return this.restService.request({url:"/api/chat/conversation/conversation",method:"GET",params:e},{apiName:this.apiName})}markConversationAsReadByInput(e){return this.restService.request({url:"/api/chat/conversation/mark-conversation-as-read",method:"POST",body:e},{apiName:this.apiName})}static{this.\u0275fac=function(o){return new(o||n)(t.KVO(r.G9T))}}static{this.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})(),_t=(()=>{class n{constructor(e){this.restService=e,this.apiName="Chat"}setSendOnEnterSettingByInput(e){return this.restService.request({url:"/api/chat/settings/send-on-enter",method:"POST",body:e},{apiName:this.apiName})}static{this.\u0275fac=function(o){return new(o||n)(t.KVO(r.G9T))}}static{this.\u0275prov=t.jDH({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})()}}]);